{% from server import server %} 
{% import pymongo %}
{% from collections import OrderedDict %}
{% import datetime %}


{% set envelope = server.mongos['default']['envelopes'].find_one({'envelope.payload_sha512' : messageid },as_class=OrderedDict) %}

{% if orient == "left" %}
<ul class='response'>
	<li>
{% else %}
	<div class="padder">
		<div class="topic_{{orient}}">
		<h3>{{envelope['envelope']['payload']['subject']}}</h3>
		<p class="meta">Received {{server.FancyDateTimeDelta(datetime.datetime.fromtimestamp(long(envelope['envelope']['local']['time_added']))).format() }}.</p>
		</div><!-- .topic_title -->		
{% end %}		


		<div class="thread_common">
		<div class="thread_{{orient}}">
			<acronym title="{{envelope['envelope']['payload']['author']['pubkey']}}">
			    <a href="/user/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}" alt="User Page">
			    	<img class="avatar" alt="User Avatar for post" src="http://RoboHash.org/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}.png?set=any&bgset=any&size=40x40"/>
			    </a>
			</acronym>
			<a href="/user/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}" alt="User Page">
			    {{envelope['envelope']['payload']['author']['friendlyname']}}<br />
			</a>
			<a href="/followuser/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}">follow</a>
		</div><!-- .thread_{{orient}} -->
		</div>
		
		<div class="clear"></div>
		{% if orient == "left" %}
		<p class="meta">Received {{server.FancyDateTimeDelta(datetime.datetime.fromtimestamp(long(envelope['envelope']['local']['time_added']))).format() }}.</p>
		{% end %}
		<div class="thread_body">
            {{envelope['envelope']['local']['formattedbody']}}
		</div><!-- .thread_start -->
		<div class="images">			
			{% if envelope['envelope']['local'].has_key('displayableattachmentlist') %}
			    {% for attachment in envelope['envelope']['local']['displayableattachmentlist'] %}
				    <a href="/binaries/{{attachment}}"><img src="/binaries/{{attachment}}-thumb"></a> <br>
			    {% end %}
			{% end %}
		</div>
		<div class="attachments">
			{% if envelope['envelope']['local'].has_key('attachmentlist') %}
			    {% for attachment in envelope['envelope']['local']['attachmentlist'] %}
			            <a href="/binaries/{{attachment['sha_512']}}">{{attachment['filename']}}</a>
			            ({{round(float(attachment['filesize'] / 1024.0 /1024.0 ),3) }} MB)<br>
			    {% end %}
			{% end %}
		</div>
		<div class="comment_bottom">
		&nbsp; <a class='internal' href="/message/{{envelope['envelope']['payload_sha512']}}/{{envelope['envelope']['local']['short_subject']}}">Permalink</a>
		{% if envelope['envelope']['payload'].has_key('regarding') %}
			&nbsp; <a class='internal' href="/message/{{envelope['envelope']['payload']['regarding']}}">Parent</a>
		{% end %}
		&nbsp; <a class="reply" message="{{envelope['envelope']['payload_sha512']}}" href="/reply/{{envelope['envelope']['payload_sha512']}}/{{envelope['envelope']['payload']['topictag'][0]}}">Reply</a>
			<div class="votes">
				<form action="/vote" method="post" id="upvote" class="vote">
				  {{ xsrf_form_html() }}
				<input type="hidden" name="rating" value="1">
				<input type="hidden" name="hash" value="{{envelope['envelope']['payload_sha512']}}">
				<input type="image" src="/static/images/t_up.png" alt="Thumbs Up on this post">
				</form>

				<form action="/vote" method="post" id="downvote" class="vote">
				  {{ xsrf_form_html() }}
				<input type="hidden" name="rating" value="-1" >
				<input type="hidden" name="hash" value="{{envelope['envelope']['payload_sha512']}}">
				<input type="image" src="/static/images/t_down.png" alt="Thumbs Down on this post">
				</form>
			</div>  <!-- votes -->
			<div id="reply_{{envelope['envelope']['payload_sha512']}}"></div>
		</div> <!-- comment_bottom -->
		{% if orient is not "left" %}
		</div> <!-- .padder -->
		{% end %}
			
		{% if envelope['envelope']['local'].has_key('citedby') %}
			{% for cite in envelope['envelope']['local']['citedby'] %}
				{{ handler.render_string('reply.html',messageid=cite,orient="left")}}
			{% end %}
		{% end %}	
		
{% if orient == "left" %}		
	</li>
</ul>			
{% end %}
