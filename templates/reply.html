{% from server import server %} 
{% import pymongo %}
{% from collections import OrderedDict %}
{% import datetime %}


{% set envelope = server.mongos['default']['envelopes'].find_one({'envelope.payload_sha512' : messageid },as_class=OrderedDict) %}

{% if orient == "left" %}
<ul class='response' id="{{envelope['envelope']['payload_sha512']}}">
	<li>
{% else %}
	<div class="padder">
		<div class="topic_{{orient}}">
		<h3>{{envelope['envelope']['payload']['subject']}}</h3>
		<p class="meta">Received <time datetime="{{datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added'])).isoformat()}}">{{server.FancyDateTimeDelta(datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added']))).format() }}.</time></p>
		</div><!-- .topic_title -->		
{% end %}		


		<div class="thread_common">
		<div class="thread_{{orient}}">
			<abbr title="{{envelope['envelope']['payload']['author']['friendlyname']}}@{{envelope['envelope']['local']['author_pubkey_sha512']}}">
			    <a href="/user/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}">
			    	<img class="avatar" alt="User Avatar for post" src="http://RoboHash.org/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}.png?set=any&amp;bgset=any&amp;size=40x40"/>
			    </a>
			<a href="/user/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}">
			    <b>{{envelope['envelope']['payload']['author']['friendlyname']}}</b>@{{envelope['envelope']['local']['author_pubkey_sha512'][0:6]}}..<br />
			</a>
			</abbr>
			
			<a href="/followuser/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}">follow</a>
		</div><!-- .thread_{{orient}} -->
		</div>
		
		<div class="clear"></div>
		{% if orient == "left" %}
		
		<p class="meta">Received <time datetime="{{datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added'])).isoformat()}}">{{server.FancyDateTimeDelta(datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added']))).format() }}.</time></p>
		
		{% end %}
		<div class="thread_body">
            {% raw envelope['envelope']['local']['formattedbody'] %}
		</div><!-- .thread_start -->
		<div class="images">			
			{% if 'displayableattachmentlist' in envelope['envelope']['local'] %}
			    {% for attachment in envelope['envelope']['local']['displayableattachmentlist'] %}
				    <a href="/binaries/{{attachment}}"><img src="/binaries/{{attachment}}-thumb" alt="Thumbnail of enclosed image"></a> <br>
			    {% end %}
			{% end %}
		</div>
		<div class="attachments">
			{% if 'attachmentlist' in envelope['envelope']['local'] %}
			    {% for attachment in envelope['envelope']['local']['attachmentlist'] %}
			            <a href="/binaries/{{attachment['sha_512']}}">{{attachment['filename']}}</a>
			            ({{round(float(attachment['filesize'] / 1024.0 /1024.0 ),3) }} MB)<br>
			    {% end %}
			{% end %}
		</div>

		{% if 'youtube' in envelope['envelope']['local'] %}
			{% for video in envelope['envelope']['local']['youtube'] %}
			<iframe class="youtube-player" type="text/html" width="640" height="385" src="http://www.youtube.com/embed/{{video}}" frameborder="0">
			</iframe>
			<br>
			{% end %}
		{% end %}

		<div class="comment_bottom">
		&nbsp; <a class='internal' href="/message/{{envelope['envelope']['local']['short_subject']}}/{{envelope['envelope']['payload_sha512']}}">Permalink</a>
		{% if 'regarding' in envelope['envelope']['payload'] %}
			&nbsp; <a class='internal' href="/message/{{envelope['envelope']['payload']['regarding']}}">Parent</a>
		{% end %}
		&nbsp; <a class="reply" message="{{envelope['envelope']['payload_sha512']}}" href="/reply/{{envelope['envelope']['payload']['topictag'][0]}}/{{envelope['envelope']['payload_sha512']}}">Reply</a>
			<div class="votes">
				<form action="/vote" method="post" class="vote">
				  {% raw xsrf_form_html() %}
				<input type="hidden" name="rating" value="1">
				<input type="hidden" name="hash" value="{{envelope['envelope']['payload_sha512']}}">
				<input type="image" src="/static/images/t_up.png" alt="Thumbs Up on this post">
				</form>

				<form action="/vote" method="post" class="vote">
				  {% raw xsrf_form_html() %}
				<input type="hidden" name="rating" value="-1" >
				<input type="hidden" name="hash" value="{{envelope['envelope']['payload_sha512']}}">
				<input type="image" src="/static/images/t_down.png" alt="Thumbs Down on this post">
				</form>
			</div>  <!-- votes -->
			<div id="reply_{{envelope['envelope']['payload_sha512']}}"></div>
		</div> <!-- comment_bottom -->
		{% if orient is not "left" %}
		</div> <!-- .padder -->
		{% end %}
			
		{% if 'citedby' in envelope['envelope']['local'] %}
			{% for cite in envelope['envelope']['local']['citedby'] %}
				{% raw handler.render_string('reply.html',messageid=cite,orient="left") %}
			{% end %}
		{% end %}	
		

{% if orient == "left" %}		
	</li>
</ul>			
{% end %}
