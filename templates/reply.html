{% from server import server %} 
{% import pymongo %}
{% from collections import OrderedDict %}
{% import datetime %}

{% set envelope = server.mongos['default']['envelopes'].find_one({'envelope.payload_sha512' : messageid },as_class=OrderedDict) %}

{% if envelope is None %}
	{% set envelope = server.error_envelope("I'm sorry, but your message can't be loaded.").dict %}
{% end %}

{% if orient == "left" %}
<ul class='response' id="{{envelope['envelope']['payload_sha512']}}">
	<li>
{% else %}
	<div class="padder">
		<div class="topic_{{orient}}">
		<h3>{{envelope['envelope']['payload']['subject']}}</h3>
		<p class="meta">Received <time datetime="{{datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added'])).isoformat()}}">{{server.FancyDateTimeDelta(datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added']))).format() }}.</time></p>
		</div><!-- .topic_title -->		
{% end %}		


		<div class="thread_common">
		<div class="thread_{{orient}} download">
			    <a href="/user/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}">
			    	<img class="avatar" alt="User Avatar for post" src="http://RoboHash.org/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}.png?set=any&amp;bgset=any&amp;size=40x40"/>
			    </a>
			<a href="/user/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}">
			    <b>{{envelope['envelope']['payload']['author']['friendlyname']}}</b>@{{envelope['envelope']['local']['author_pubkey_sha1']}}<br />
			</a>
			
			<a href="/followuser/{{''.join(envelope['envelope']['payload']['author']['pubkey'].split())}}">follow</a>
		</div><!-- .thread_{{orient}} -->
		<div class="tooltip">
			<img src="http://static.flowplayer.org/img/title/eye.png" alt="Flying screens" 
				style="float:left;margin:0 15px 20px 0" />
			<table style="margin:0">
				<tr>
					<td class="label">File</td>
					<td>flowplayer-3.2.7.zip</td>
				</tr>
				<tr>
					<td class="label">Date</td>
					<td>2011-03-03</td>
				</tr>
				<tr>
					<td class="label">Size</td>
					<td>112 kB</td>
				</tr>
				<tr>
					<td class="label">OS</td>
					<td>all</td>
				</tr>		
			</table>
			<a href="/3.2/">What's new in 3.2</a>
		</div>
		
		
		</div>
		
		<div class="clear"></div>
		{% if orient == "left" %}
		
		<p class="meta">Received <time datetime="{{datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added'])).isoformat()}}">{{server.FancyDateTimeDelta(datetime.datetime.fromtimestamp(int(envelope['envelope']['local']['time_added']))).format() }}.</time></p>
		
		{% end %}
		<div class="thread_body">
            {% raw envelope['envelope']['local']['formattedbody'] %}
		</div><!-- .thread_start -->
		<div class="images">			
			{% if 'displayableattachmentlist' in envelope['envelope']['local'] %}
			    {% for attachment in envelope['envelope']['local']['displayableattachmentlist'] %}
				    <a href="/binaries/{{attachment}}"><img src="/binaries/{{attachment}}-thumb" alt="Thumbnail of enclosed image"></a> <br>
			    {% end %}
			{% end %}
		</div>
		<div class="attachments">
			{% if 'attachmentlist' in envelope['envelope']['local'] %}
			    {% for attachment in envelope['envelope']['local']['attachmentlist'] %}
			            <a href="/binaries/{{attachment['sha_512']}}"><bdi>{{attachment['filename']}}</bdi></a> ({{round(float(attachment['filesize'] / 1024.0 /1024.0 ),3) }} MB)<br>
			            <div class="othercopies">Search for other messages with the <a href="/attachment/{{attachment['sha_512']}}">same attachment</a></div>
                                    <br>
			    {% end %}
			{% end %}
		</div>

		{% if 'youtube' in envelope['envelope']['local'] %}
			{% for video in envelope['envelope']['local']['youtube'] %}
			<iframe class="youtube-player" type="text/html" width="640" height="385" src="https://www.youtube.com/embed/{{video}}?wmode=opaque" frameborder="0">
			</iframe>
			<br>
			{% end %}
		{% end %}
		
		{% if 'vimeo' in envelope['envelope']['local'] %}
			{% for video in envelope['envelope']['local']['vimeo'] %}
			
			<iframe src="http://player.vimeo.com/video/{{video}}" width="640" height="385" frameborder="0"></iframe>
			<br>
			{% end %}
		{% end %}

		<div class="comment_bottom">
		&nbsp; <a class='internal' href="/message/{{envelope['envelope']['local']['short_subject']}}/{{envelope['envelope']['payload_sha512']}}">Permalink</a>
		{% if 'regarding' in envelope['envelope']['payload'] %}
			&nbsp; <a class='internal' href="/message/{{envelope['envelope']['payload']['regarding']}}">Parent</a>
		{% end %}
		&nbsp; <a class="reply" message="{{envelope['envelope']['payload_sha512']}}" href="/reply/{{envelope['envelope']['payload']['topic']}}/{{envelope['envelope']['payload_sha512']}}">Reply</a>
			<div class="votes">
				<form action="/vote" method="post" class="vote">
				  {% raw xsrf_form_html() %}
				<input type="hidden" name="rating" value="1">
				<input type="hidden" name="hash" value="{{envelope['envelope']['payload_sha512']}}">
				<abbr title= "This post was helpful."><input type="image" src="/static/images/t_up.png" alt="Thumbs Up on this post"></abbr>
				</form>

				<form action="/vote" method="post" class="vote">
				  {% raw xsrf_form_html() %}
				<input type="hidden" name="rating" value="-1" >
				<input type="hidden" name="hash" value="{{envelope['envelope']['payload_sha512']}}">
				<abbr title="This post was inappropriate."><input type="image" src="/static/images/t_down.png" alt="Thumbs Down on this post"></abbr>
				</form>
			</div>  <!-- votes -->
			{% if orient == "right" %}
			<div class="externalsharing">
			Share this post on <a href="http://www.facebook.com/sharer.php?u=http://ForumLegion.ch/message/{{envelope['envelope']['local']['short_subject']}}/{{envelope['envelope']['payload_sha512']}}&t={{envelope['envelope']['local']['short_subject']}}">Facebook</a>, <a href="http://twitter.com/home?status=Check out this post, via @ForumLegion - {{envelope['envelope']['local']['short_subject']}}%0A%0A%0Ahttp://ForumLegion.ch/message/{{envelope['envelope']['local']['short_subject']}}/{{envelope['envelope']['payload_sha512']}}" >Twitter</a> or <a href="https://plusone.google.com/_/+1/confirm?hl=en&url=http://ForumLegion.ch/message/{{envelope['envelope']['local']['short_subject']}}/{{envelope['envelope']['payload_sha512']}}">Google+</a>.
			</div>
			{% end %}
			<div id="reply_{{envelope['envelope']['payload_sha512']}}"></div>
		</div> <!-- comment_bottom -->
		{% if orient is not "left" %}
		</div> <!-- .padder -->
		{% end %}
			

<form action="/usertrust" method="post">
  {% raw xsrf_form_html() %}
<input type="hidden" name="trust" value="100">
<input type="hidden" name="topic" value="{{envelope['envelope']['payload']['topic']}}">
<input type="hidden" name="trusted_pubkey" value="{{envelope['envelope']['payload']['author']['pubkey']}}">
<input type="submit" value="Trust This User">
</form>

<form action="/usertrust" method="post">
  {% raw xsrf_form_html() %}
<input type="hidden" name="trust" value="-100">
<input type="hidden" name="topic" value="{{envelope['envelope']['payload']['topic']}}">

<input type="hidden" name="trusted_pubkey" value="{{envelope['envelope']['payload']['author']['pubkey']}}">
<input type="submit" value="Distrust This User">
</form>

		{% if 'citedby' in envelope['envelope']['local'] %}
			{% for cite in envelope['envelope']['local']['citedby'] %}
				{% raw handler.render_string('reply.html',messageid=cite,orient="left") %}
			{% end %}
		{% end %}	
		

{% if orient == "left" %}		
	</li>
</ul>			
{% end %}
