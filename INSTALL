# This project requires Python 3.
# If you're on OS X, I suggest Homebrew, rather than MacPorts or Fink.

# Ensure you have the proper system-level libraries.
apt-get install g++  libpcre3-dev zlib1g-dev libssl-dev python-dev swig libfreetype6 libfreetype6-dev libjpeg8-dev libjpeg8 libzzip-dev libxml2-dev libxslt-dev python3 python3-dev
sudo apt-get build-dep python-imaging


ln -s /usr/bin/python3.2 /usr/bin/python

brew install Boost
brew install mongodb python3 


#On 64 bit
apt-get install lib32z1


sudo apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10
echo "deb http://downloads-distro.mongodb.org/repo/debian-sysvinit dist 10gen" >> /etc/apt/sources.list

apt-get update
apt-get install mongodb-10gen


cd /usr/local/src
wget http://nginx.org/download/nginx-1.0.2.tar.gz
tar -zxvf nginx-1.0.2.tar.gz
cd nginx-1.0.2
git clone https://github.com/vkholodkov/nginx-upload-module.git
cd nginx-upload-module
git checkout 2.2
cd ..

git clone https://github.com/mdirolf/nginx-gridfs.git
cd nginx-gridfs
git submodule init
git submodule update
cd ..
./configure --add-module=/usr/local/src/nginx-1.0.2/nginx-upload-module --add-module=/usr/local/src/nginx-1.0.2/nginx-gridfs --with-http_ssl_module  --prefix=/opt/nginx
make
make install


mkdir /opt/uploads
chmod 777 /opt/uploads/

cd /opt
git clone git@github.com:e1ven/Tavern.git

cd /opt/Tavern/nginx
cp nginx.conf /opt/nginx/conf/


cd /opt/Tavern/libs/distribute-0.6.24/
python3 distribute_setup.py


cd /opt/Tavern/libs/Cython-0.15.1
python3 setup.py install

cd /opt/Tavern/libs/Mako-0.5.0
python3 setup.py install

brew install exiv2


cd /opt/Tavern/lib
git clone https://github.com/mikeboers/PyTomCrypt.git
cd /opt/Tavern/libs/PyTomCrypt
# You need to make sure cython works for this step.
# If you are on OS X, set add /usr/local/bin as top of /etc/paths
sudo ln -s /usr/local/bin/python3 /usr/local/bin/python
sudo ln -s /usr/local/share/python3/cython /usr/local/bin/cython
# sudo ln -s  /opt/local/Library/Frameworks/Python.framework/Versions/3.2/bin/cython /usr/local/bin/cython

make sources
python3 setup.py build
python3 setup.py install


cd /opt/Tavern/libs/tornado-2.1.1
python3 setup.py install


mkdir -p /usr/local/share/GeoIP
cp /opt/Tavern/libs/GeoIPCity.dat /usr/local/share/GeoIP/GeoIPCity.dat

cd /opt/Tavern/libs/pygeoip-0.2.2
python3 setup.py install


cd /opt/Tavern/libs/Markdown-2.1.0 
# 2to3 has already been run on git version
# If you redownload, re-run it.
python3 setup.py install


cd /opt/Tavern/libs/pymongo3-1.9b1/
python3 setup.py install


cd /opt/Tavern/libs/postmarkup-1.1.4/
# Use my modified version
python3 setup.py install

cd /opt/Tavern/libs/
hg clone http://bitbucket.org/mhallin/py-scrypt
cd py-scrypt
python3 setup.py install

cd /opt/Tavern/libs/pbkdf2-1.3
python3 setup.py install


cd /opt/Tavern/libs
git clone https://github.com/grahame/pil-py3k
cd /opt/Tavern/libs/pil-py3k
# Enable jpg support by linking, on 64 bit.
    vi setup.py
    on page 196, add
    add_directory(library_dirs, "/usr/lib/x86_64-linux-gnu")

python3 setup.py install


cd /opt/Tavern/libs
git clone https://github.com/fancycode/pylzma.git
cd /opt/Tavern/libs/pylzma
python3 setup.py install

cd /opt/Tavern/libs/lxml-2.3/
python3 setup.py build
python3 setup.py install

cd /opt/Tavern/libs/BeautifulSoup-4.0b
python3 setup.py install

echo "/usr/bin/python /opt/Tavern/TopicList.py" > /etc/cron.hourly/generatetopics
echo "/usr/bin/python /opt/Tavern/ModList.py" > /etc/cron.daily/findmods


ln -s /opt/Tavern/libs/Tavern /etc/init.d/

cd /opt/Tavern/
python ./generateNginx.py 

/etc/init.d/mongodb start
/opt/nginx/sbin/nginx

/etc/init.d/Tavern start


SETTINGS
Most settings should work automatically out of the box, but you may want to modify Domains to run things on your own.
For instance, the serversetting 'embedserver' sends users to embed.is for embedded iframes.
Feel free to run your own embed server, and change this setting to use it.

Also, for production, you should change probably run a separate binaries server from / to a new domain.
This will prevent cookie reading attacks.


